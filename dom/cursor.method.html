<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é¼ æ ‡è¡Œä¸ºã€æ‹–æ‹½</title>
    <script src="./utils.js"></script>
    <style>
      body {
        height: 1000px;
      }
      .box {
        position: absolute;
        top: 200px;
        left: 200px;
        width: 100px;
        height: 100px;
        background-color: #6c7b8b;
      }
      .inner {
        display: none;
        position: absolute;
        left: -50px;
        width: 100px;
        height: 100px;
        background-color: #ffefd5;
      }
      span {
        position: absolute;
        left: 200px;
        top: 100px;
      }
      .block {
        width: 1000px;
        height: 100px;
        background-color: #bbffff;
      }
    </style>
  </head>
  <body>
    <div class="box"></div>
    <div class="inner"></div>
    <span>123123123</span>
    <div class="block"></div>
  </body>
  <script>
    // ğŸŒŸ é¼ æ ‡è¡Œä¸ºï¼ˆåæ ‡ç³»å±æ€§ï¼‰
    // clientX/Y é¼ æ ‡ä½ç½®ç›¸å¯¹äºæµè§ˆå™¨è§†å£çš„åæ ‡ï¼ˆä¸åŒ…å«æ»šåŠ¨çš„è·ç¦»ï¼‰
    // x/y åŒclientç›¸åŒï¼Œä½†æ˜¯è€ç‰ˆFFä¸æ”¯æŒ
    // pageX/Y é¼ æ ‡ä½ç½®ç›¸å¯¹äºæ•´ä¸ªæ–‡æ¡£çš„åæ ‡ï¼Œä½†æ˜¯IE9ä»¥ä¸‹ä¸æ”¯æŒï¼ˆåŒ…å«æ»šåŠ¨çš„è·ç¦»ï¼‰
    // layerX/Y åŒpageXç›¸åŒï¼Œä½†æ˜¯IE11ä»¥ä¸‹åŒclientç›¸åŒï¼ˆå¦‚æœå…ƒç´ è®¾ç½®absoluteã€fixedã€stickyåŒoffsetç›¸åŒï¼‰
    // screenX/Y é¼ æ ‡ä½ç½®ç›¸å¯¹äºæ•´ä¸ªç”µè„‘å±å¹•çš„åæ ‡
    // offsetX/Y é¼ æ ‡ä½ç½®ç›¸å¯¹äºå½“å‰å…ƒç´ çš„åæ ‡ï¼ˆåŒ…å«è¾¹æ¡†ï¼Œsafariä¸åŒ…å«è¾¹æ¡†ï¼‰
    document.onclick = function (event) {
      console.log('screenX/Y:', event.screenX, event.screenY)
      console.log('clientX/Y:', event.clientX, event.clientY)
      console.log('x/y:', event.x, event.y)
      console.log('pageX/Y:', event.pageX, event.pageY)
      console.log('layerX/Y:', event.layerX, event.layerY)
      console.log('offsetX/Y:', event.offsetX, event.offsetY)
      console.log('pagePos:', pagePos(event))
    }

    // ğŸŒ° é¼ æ ‡ä½ç½®åç§»é‡å…¼å®¹æ€§å°è£…ï¼ˆè§£å†³offsetX/Yåœ¨safariä¸­è¾¹æ¡†é—®é¢˜ï¼‰
    function pagePos(event) {
      var sLeft = getScrollOffset().left,
        sTop = getScrollOffset().top,
        // æ–‡æ¡£çš„åç§»é‡é€šå¸¸éƒ½æ˜¯0ï¼Œä½†æ˜¯è¿™é‡Œéœ€è¦å…¼å®¹IE8åŠä»¥ä¸‹
        cLeft = document.documentElement.clientLeft || 0,
        cTop = document.documentElement.clientTop || 0
      return {
        x: sLeft + event.clientX - cLeft,
        y: sTop + event.clientY - cTop,
      }
    }

    // ğŸŒŸ é¼ æ ‡å·¦ä¸­å³é”® button=0ã€1ã€2ï¼ˆIE10ä»¥ä¸‹çš„å€¼å„ä¸ç›¸åŒï¼‰
    document.onmousedown = function (e) {
      var target = e || window.event
      console.log(target.button)
    }

    // ğŸŒŸ é¼ æ ‡æ‹–æ‹½äº‹ä»¶
    var boxEl = document.getElementsByClassName('box')[0],
      menuEl = document.getElementsByClassName('inner')[0]
    // ğŸŒ° å°è£…å…ƒç´ æ‹–æ‹½ï¼Œæ”¯æŒå…ƒç´ åŒå‡»è§¦å‘å›è°ƒï¼ŒåŒå‡»èœå•å±•ç¤ºï¼Œè¾¹ç•Œå€¼å¤„ç†
    function elemDrag(opt) {
      var x,
        y,
        w = getStyles(opt.el, 'width'), // å…ƒç´ å®½åº¦
        h = getStyles(opt.el, 'height'), // å…ƒç´ é«˜åº¦
        maxW = getViewportSize().width, // å¯è§†åŒºåŸŸæœ€å¤§å®½åº¦
        maxH = getViewportSize().height, // å¯è§†åŒºåŸŸæœ€å¤§é«˜åº¦
        mW = getStyles(opt.menu, 'width'), // èœå•å®½åº¦
        mH = getStyles(opt.menu, 'height'), // èœå•é«˜åº¦
        sTime = 0, // è®°å½•è§¦å‘ç‚¹å‡»äº‹ä»¶çš„å¼€å§‹æ—¶é—´
        eTime = 0, // è®°å½•è§¦å‘ç‚¹å‡»äº‹ä»¶çš„ç»“æŸæ—¶é—´
        iPos = [], // è®°å½•å…ƒç´ åˆå§‹åæ ‡
        csTime = 0, // è®°å½•å…ƒç´ åŒå‡»ä¹‹é—´çš„å¼€å§‹æ—¶é—´
        ceTime = 0, // è®°å½•å…ƒç´ åŒå‡»ä¹‹é—´çš„ç»“æŸæ—¶é—´
        counter = 0, // è®°å½•å…ƒç´ åŒå‡»é—´æ¬¡æ•°
        timeId = null

      addEvent(opt.el, 'mousedown', function (e) {
        var target = e || window.event,
          buttonCode = target.button

        sTime = new Date().getTime()
        iPos.push(getStyles(opt.el, 'top'), getStyles(opt.el, 'left'))

        // é¼ æ ‡ä½ç½®è·ç¦»å…ƒç´ å†…å›ºå®šåç§»é‡ = é¼ æ ‡ä½ç½®è·æ–‡æ¡£åç§»é‡ - å…ƒç´ è·æ–‡æ¡£åç§»é‡
        x = pagePos(target).x - getStyles(opt.el, 'left')
        y = pagePos(target).y - getStyles(opt.el, 'top')

        // å¢åŠ å³é”®å¼¹å‡ºèœå•æ¡†é€‰é¡¹
        if (buttonCode == 2) {
          var mLeft = pagePos(target).x,
            mTop = pagePos(target).y

          // è¾¹ç•Œæƒ…å†µ
          mLeft = mLeft < 0 ? 0 : mLeft
          mTop = mTop < 0 ? 0 : mTop
          mLeft = mLeft > maxW - mW ? mLeft - mW : mLeft
          mTop = mTop > maxH - mH ? mTop - mH : mTop

          opt.menu.style.top = mTop + 'px'
          opt.menu.style.left = mLeft + 'px'
          opt.menu.style.display = 'block'
        } else if (buttonCode == 0) {
          opt.menu.style.display = 'none'
          addEvent(document, 'mousemove', mouseMove)
          addEvent(document, 'mouseup', mouseUp)
          // é˜»æ­¢äº‹ä»¶æºå†’æ³¡å’Œé»˜è®¤äº‹ä»¶
          cancelBubble(target)
          preventDefault(target)
        }
      })
      function mouseMove(e) {
        var target = e || window.event,
          // å…ƒç´ ç§»åŠ¨çš„è·ç¦» = é¼ æ ‡ä½ç½®è·æ–‡æ¡£ç§»åŠ¨åè·ç¦» - é¼ æ ‡ä½ç½®è·ç¦»å…ƒç´ å†…å›ºå®šåç§»é‡
          left = pagePos(target).x - x,
          top = pagePos(target).y - y

        // è¾¹ç•Œæƒ…å†µ
        left = left < 0 ? 0 : left
        top = top < 0 ? 0 : top
        left = left > maxW - w ? maxW - w : left
        top = top > maxH - h ? maxH - h : top

        opt.el.style.top = top + 'px'
        opt.el.style.left = left + 'px'
      }
      function mouseUp() {
        eTime = new Date().getTime()

        // å°äºé—´éš”çš„ 300 æ¯«ç§’ï¼Œè§¦å‘ç‚¹å‡»äº‹ä»¶å¹¶å°†è¯¥å…ƒç´ è¿˜åŸåˆå§‹ä½ç½®
        if (eTime - sTime <= 300) {
          opt.el.style.top = iPos[0] + 'px'
          opt.el.style.left = iPos[1] + 'px'

          // è§¦å‘ç‚¹å‡»
          counter++

          if (counter == 1) {
            csTime = new Date().getTime()
          }
          if (counter == 2) {
            ceTime = new Date().getTime()
          }
          // åŒå‡»é—´éš”æ—¶é•¿å°äº 300 æ¯«ç§’åˆ™è°ƒç”¨å›è°ƒå‡½æ•°
          if (csTime && ceTime && ceTime - csTime < 300) {
            opt.cb()
          }
          // è§£å†³åªç‚¹å‡»äº†ä¸€æ¬¡è®°å½•counteræœªæ¸…ç©ºé—®é¢˜bug
          timeId = setTimeout(function () {
            csTime = 0
            ceTime = 0
            counter = 0
            clearTimeout(timeId)
          }, 400)
        }

        removeEvent(document, 'mousemove', mouseMove)
        removeEvent(document, 'mouseup', mouseUp)
      }

      // é˜»æ­¢å³é”®çš„é»˜è®¤äº‹ä»¶
      addEvent(document, 'contextmenu', function (e) {
        var target = e || window.event
        preventDefault(target)
      })

      // ç‚¹å‡»æ–‡æ¡£åŒºåŸŸå–æ¶ˆèœå•å±•ç¤º
      addEvent(document, 'click', function (e) {
        var target = e || window.event
        opt.menu.style.display = 'none'
      })

      // ç‚¹å‡»èœå•ç¦æ­¢å†’æ³¡åˆ°é¡¶çº§å–æ¶ˆå±•ç¤º
      addEvent(opt.menu, 'click', function (e) {
        var target = e || window.event
        cancelBubble(target)
      })
    }

    elemDrag({
      el: boxEl,
      menu: menuEl,
      cb: function () {
        window.location.href = 'http://www.baidu.com'
      },
    })

    function drag(el) {
      var x, y

      addEvent(el, 'mousedown', function (e) {
        var event = e || window.event
        // è·å–é¼ æ ‡ä¸‹è½ç‚¹ä½äºå…ƒç´ 0ï¼Œ0çš„å›ºå®šè·ç¦»
        x = pagePos(event).x - getStyles(el, 'left')
        y = pagePos(event).y - getStyles(el, 'top')

        addEvent(document, 'mousemove', mouseMove)
        addEvent(document, 'mouseup', mouseUp)
      })

      function mouseMove(e) {
        var event = e || window.event
        // å…ƒç´ ç§»åŠ¨åçš„è·ç¦» - å›ºå®šè·ç¦» = è¦ç§»åŠ¨çš„ä½ç½®
        el.style.left = pagePos(event).x - x + 'px'
        el.style.top = pagePos(event).y - y + 'px'
      }

      function mouseUp(e) {
        var event = e || window.event
        removeEvent(document, 'mousemove', mouseMove)
        removeEvent(document, 'mouseup', mouseUp)
      }
    }

    // drag(boxEl)
  </script>
</html>
