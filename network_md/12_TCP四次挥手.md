### TCP 四次挥手

- 标志位：数据包
  - FIN：finish 关闭连接
  - ACK：确认包
  - seq：序列号
  - ack：确认上一次请求已收到的确认包
- 状态：
  - FIN-WAIT-1：客户端发送中断连接
  - CLOSE-WAIT：服务器收到客户端中断连接并发送确认包
  - FIN-WAIT-2：客户端收到服务器的确认请求
  - LAST-ACK：服务器待所有数据响应完毕并再次发送确认包
  - TIME-WAIT：客户端收到服务器连接关闭的确认包并发送接收确认包
  - CLOSED：连接状态已关闭

### 过程

- 第一次挥手：客户端向服务器发送 FIN=1、序列号 seq=u 的报文断开连接，客户端进入 FIN-WAIT-1 状态
- 第二次挥手：服务器收到客户端的中断请求并发送 ACK=1、序列号 seq=v、ack=u+1 的报文，客户端收到服务器的确认包后进入 FIN-WAIT-2 状态，服务器会进入 CLOSE-WAIT 状态，此时服务器处于半关闭状态，服务器会检查是否还有数据需要响应
  - 如果有则继续返回数据
  - 如果没有服务器会向客户端再次发送关闭连接的确认包
- 第三次挥手：服务器发送 FIN=1、ACK=1、序列号 seq=w、ack=u+1 的报文并进入 LAST-ACK 状态
- 第四次挥手：客户端收到服务器关闭连接报文后，并发送 ACK=1、序列号 seq=u+1、ack=w+1 的报文，客户端进入 TIME-WAIT 状态（同时等待 2MSL 时长），服务器收到客户端的确认请求后立即进入 TCP 连接关闭状态 CLOSED（TCP 关闭，服务器比客户端早一些）

### 2MSL

- 定义：TIME-WAIT 时长 2MSL Maximum Segment Lifetime 最大报文生存时间
- 时长：MSL 的值根据不同的情况而不同，一般是 30 秒、1 分钟、2 分钟
- 目的：保证客户端发送的最后一个报文能够发到服务器，一旦报文丢失，服务器会认为，自己最后一次发送的 FIN+ACK 包，客户端并没有收到，此时，服务器会重新发送一次 FIN+ACK 包，而客户端可以在 2MSL 的 TIME-WAIT 时间内收到重新传输的 FIN+ACK 包，接着重新进行第四次挥手，并重启 2MSL 计时器

### 为什么是四次挥手

- 原因：第一次挥手的时候发送了 FIN 包，服务器接收到以后，表示客户端不再发送数据了，但还能接收数据。这时服务器先向客户端先发送确认包，并且确认自己是否还有数据没有发送给客户端，这个确认的阶段是 CLOSE-WAIT，所以在终止等待 1（CLOSE-WAIT）的开始和结束需要各发送一个包，状态开始时向客户端发送的包是确认收到来自客户端的 FIN 包，状态结束时向客户端发送的是确认数据已经发送完毕, 所以是四次挥手

### TCP 连接建立后，客户端突然出现故障

- TCP 保活计时器：客户端如果出现故障，服务器每收到一次客户端的请求后都会重新复位保活计时器，时间通常是 2 小时，若 2 小时还没有收到客户端的数据，服务器就会发送一个探测报文段，以后每隔 75 分钟发送一次。若一连发送 10 个探测报文仍无反应，服务器就认为客户端出了故障，此时将关闭连接
