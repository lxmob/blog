比特币系统中全节点要在内存中维护一个utxo(unspent transaction output)的数据结构
所有没有被花掉的输出组成的集合就是utxo
utxo中每个元素要给出产生这个输出交易的哈希值，以及它在这个交易中是属于第几个输出
这样做是为了检测double spending，在utxo集合中检查当前交易是否存在，存在即合法
所有输入的金额要等于输出的金额(total inputs = total outputs)
也有情况是属于输入的金额大于输出的金额，这种情况下多出的部分会作为矿工的出块手续费

除了出块奖励矿工为什么要把你的交易作为数据块打包进区块呢？
假设有一个自私的节点只将自己的交易记录打包进区块，其它的交易对于它来说还需要验证交易的合法性
而且区块内容多的话还会占用带宽利用率，对于这种节点光有出块奖励是不够的，它就会不管其他人的交易
所以比特币系统中就有第二种激励机制，交易手续费
比特币系统中设计的出块时间是每10分钟出一个区块，那么出块奖励大约是每隔4年减半
大概是在2140年比特币就会被挖完，到那个时候手续费就会作为唯一的奖励机制了

基于交易的分类账(transaction-based ledger)
比特币这种基于交易的模式，隐私保护性好
代价就是需要在交易过程中说明币的来源，它没有账户的概念没有地方去记录你有几个BTC
以太坊中就不需要去说明币的来源这个问题，它属于基于账户的分类账(account-based ledger)

区块记录信息
https://blockstream.info/

挖矿难度为什么要调整？
为了保证每一个区块的出块时间固定在10分钟
在上一个难度目标调整周期内，平均出块时间超过10分钟，那么降低挖矿难度增大难度目标
反之则提高挖矿难度减小难度目标，每隔2016个区块都会调整一下挖矿难度，大约14天

block header中nonce阈值它的类型是32位无符号整数，挖矿过程中是需要调整nonce的
但是nonce最多只有2的32次方个可能的取值，按照比特币挖矿难度就算是把2的32次方个可能的取值
都遍历一遍很可能仍然是找不到符合难度要求的目标阈，因为比特币的热度导致挖矿难度的增加
单纯靠调整block header中的这个nonce是大概率找不到目标阈的，搜索空间不够大

如何增加搜索空间呢？
调整block header中merkle root hash，每个发布的区块里都有一笔特殊的铸币交易
这笔交易是没有输入只有输出的，属于发行币凭空造币，它有一个coinbase域可以在这里面写入信息
遵循前面说的digital commitment性质，可以将commit hash写入这里(股票例子)
也可以写入其它的内容，无人监管，相当于一个备注信息栏

这个coinbase域对于挖矿有什么用呢？
当更改了铸币交易中coinbase域的信息，这个交易的哈希值就会产生变化，通过merkle tree向上传递
最后导致block header中的merkle root hash发生变化，所以可以把它当作额外的随机数空间(extra-nonce)
例如把coinbase中前8byte作为extra-nonce来使用，这样搜索空间就增大到2的96次方(1byte=8bit)
所以真正挖矿的时候是有两层循环的，外层循环去调整extra-nonce的难度，内层循环去寻找符合的目标阈

伯努利试验(bernoulli trial:a random experiment with binary outcome)
只有两种结果的可能性，例如掷硬币，正面朝上的概率是p，反面朝上的概率就是1-p
通过大量的bernoulli trial就会形成
伯努利过程(bernoulli process:a seqnence of independent bernoulli trials)
bernoulli process的性质属于无记忆性(memoryless)
在大量的实验中前面的结果对后面的结果是没有影响的，概率是一致的

对于挖矿来说每次尝试的nonce成功可能性很小，那么就需要尝试大量的nonce才能找到符合要求的数
这种情况下可以让bernoulli process去使用泊松分布(poisson process)来推导出系统出块时间
整个系统的出块时间是由指数分布(exponential distribution)
具体到每一个矿工，能够挖到下一个区块的时间取决于矿工的算力占据系统算力的百分比
例如你的算力占据系统的1%那么系统中每产生100个区块中就有一个区块是你挖出来的
平均每1000分钟你可以产生一个区块

关于防范分叉攻击详解
假设大部分算力是掌握在诚实节点手里，那么恶意节点想要进行分叉攻击的成功性很小
恶意节点只获得一次记账权是不够的，接下来还要获取记账权，超过诚实节点算力才能达到攻击目的
在比特币中防范这种攻击的方式就是多等几个确认区块(x confirmation)
比特币中是需要等待6个区块才能够认为前面想要分叉的区块是不可被篡改的，平均等待1个小时

selfish mining attach
分叉攻击时假设恶意的节点已经将当前区块的nonce找到了，但是不广播节点，提前继续算下一个区块
直到算到第7个区块时，将所有已经算好的区块全部广播出去，那么该怎么防范呢？
当一个恶意节点已经能够藏着不发布已经算好的区块，并且还能够算出接下来的6个区块
它就已经掌握了超过51%的算力了，还是算力比拼略带一点运气

比特币规定每个区块的大小容量不能超过1mb，如果交易量较大只能等到下一个区块确认
