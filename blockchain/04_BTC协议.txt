纸质货币
由央行批量印钞统一发行
每一张纸质货币都有央行的防伪标志又称货币序列号
国家政府机构作背书，货币的价值是与国家宏观经济挂钩


数字货币
数字货币也可以由央行发行，属于中心化管理
假设现在发生一笔交易，由我向你转入一个数字货币
你可以通过央行的公钥验证数字货币的真伪，验证后确实是由央行私钥签名发行的
这里数字货币并没有用到区块链技术，而是用到了密码学中的非对称加密算法


什么是双花攻击(double spending attack)
数字货币就是一块数据文件
通过非对称加密算法对文件内容加密，是无法伪造的，但是可以复制
例如我账户中有100元的数字货币，我将100元数字货币复制多份，到不同商家进行消费
这个就属于双花攻击或双重支付，与纸质货币不同，纸质货币交易出去就没有了


数字货币面临的主要挑战就是怎么防范双花攻击
具体解决方案，让央行在数据库中维护一张表，来记录发行数字货币的编号
通过这个编号在表中维护当前编号的数字货币在谁手中，每当发生交易时不仅要验证该币的真伪
还要向央行验证这个币是否在对方手中，如果确实存在才可以进行交易
然后央行再把这个币的编号记录指向下一个人，这样就能够防止双花攻击
属于中心化的解决方案，缺点维护不方便、每次交易都要查询一遍、数据库容易被攻击


比特币设计的去中心化方案要解决数字货币的两个问题
数字货币由谁发行、发行的时间和数量？
如何验证交易的有效性、怎么防范双花攻击？


怎么防范双花攻击？
比如有一个用户A他获得了发行货币的权力，比特币中称为铸币权(create coin)
假设A发行了10个比特币，A将10个比特币交易给B和C，每个人各5个比特币
这笔交易需要A的签名(signed by A)证明是A同意的
同时这笔交易还要说明交易10个比特币的来源，来源指向铸币交易


比特币系统中每笔交易都包含了输入和输出两个部分
输入要说明币的来源，输出部分要给出收款人的公钥哈希值
交易区块中除了哈希指针还有另外一种指针，指向前面某个交易中币的来源
其实就是输出部分，为了说明币的来源，保证币的来源可靠性，同时防范了双花攻击


一笔交易中不仅要知道A的公钥还需要知道B的公钥
B的公钥是让A用户使用加密交易信息
A的公钥是让B用户知道是谁转的这笔交易
同时系统中节点都需要知道A的公钥来验证交易的合法性


A的公钥可以是由A用户给出吗？
思考一个问题假设A的公钥由A来说明，会导致怎样的问题？
会产生严重的安全漏洞，假设有一个B'用户去伪造A的交易，并在交易中给出自己的公钥
来说明这是A的公钥，然后用自己的私钥签名，这样导致系统中节点在验证交易时
通过冒名顶替的公钥去验证签名确实是对的，就会以为这笔交易是合法的


如何防范这个问题呢？
比特币在设计时，当A用户产生铸币交易(coinbase tx)时
它的输出脚本中包含了A的公钥哈希值
所以转账交易中说明A的公钥要与A币来源里面的公钥哈希值保持一致才可以


如何验证交易的合法性？
比特币中是没有账户余额概念的，它是基于交易记录模式
每个交易的输入作为一段脚本程序、输出作为一段脚本程序(bitcoin script)
将当前交易块的输入脚本与提供币来源的区块中输出脚本合并一起检查脚本
如果没有任何错误就是验证通过，注意不是运行脚本而是check脚本
只有要花这笔交易输出的时候才会执行这个交易的输出脚本


区块链账本需要达成分布式的共识(distributed consensus)
即我本地维护的账本要和你本地维护的账本达成一致，才能叫做去中心化账本
如果每个人系统本地维护的账本都不一样缺乏一致性，这样没有任何意义


如何使系统中节点达成共识？
比特币设计共识协议是基于系统中有一些节点是恶意的，但是系统中大部分节点是好的
有恶意的节点只是占用一小部分，通过投票的方式让参与交易的节点都进行投票少数服从多数来达成共识
决定是否将这个区块写入到区块链账本中，但是谁都可以投票那就会产生问题


女巫攻击(Sybil Attack)
攻击者通过创建多个账号节点来达成对系统的控制


比特币中采用的也是投票方式，但不是按照账户数目投票，而是通过算力投票
每个节点都可以在本地将合法的交易组装成区块然后开始不断的尝试随机数(nonce)
如果有一个找到符合的nonce那么它就获得了记账权，将区块写入区块链中进行广播消息
其它节点收到消息后要验证一下该区块的合法性，首先检查区块头中目标阈值是否符合要求
然后检查区块体中的交易列表，验证一下每个交易是否都是合法的，是否有签名、是否被双花
如果有一项不符合要求那么这个区块是不能被诚实节点接受的


什么是最长合法链？
某个节点新发布的区块但不是链上最新的区块，是插在区块链账本中间的一个位置
这种情况属于算力不对等的情况，比特币协议规定合法的区块要遵循最长合法链原则
即发布的区块要保持在最长链当中，出现分叉的区块不算做合法链当中的有效区块


分叉攻击(forking attack)
通过向区块链中间插入一个区块，来回滚某个已经发生的交易
假设大部分算力是掌握在诚实节点手里，那么恶意节点想要进行分叉攻击的成功性很小
恶意节点只获得一次记账权是不够的，接下来还要获取记账权，超过诚实节点算力才能达到攻击目的
在比特币中防范这种攻击的方式就是多等几个确认区块(x confirmation block)
比特币中是需要等待6个区块才能够认为前面想要分叉的区块是不可被篡改的，平均等待1个小时


区块链在正常情况下也可能发生分叉，有两个节点同时获得记账权
这种等长的临时性分叉会维持一段时间，直到有一个分叉是胜出的，遵循最长合法链原则
那如果短链中发生的铸币交易，在后续的记账中是不会被大多数诚实节点所接受的


出块奖励(block reward)
比特币设计的系统中通过出块奖励激励矿工来将交易打包成区块
比特币协议中规定获得记账权的那个节点，在发布的区块中可以有一个特殊交易
就是前面说的铸币交易(coinbase transaction)，在这个交易中可以发行一定数量的比特币
比特币协议规定在最开始记账时每发布一个区块奖励是50BTC，在21万个区块后这个奖励要减半也就是12.5BTC
当一个节点获得的哈希率(hash rate)越高那么这个节点得到记账权的权重就会越高，出块奖励概率也越大


交易手续费(transaction fee)
比特币设计的系统中有第二种激励机制，交易手续费，为了鼓励矿工积极打包交易区块
比特币系统中设计的出块时间是每10分钟出一个区块，出块奖励大约是每隔4年减半
大概是在2140年比特币就会被挖完，到那个时候手续费就会作为唯一的奖励机制了
